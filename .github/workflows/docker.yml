name: Build Docker Image
true:
  push:
    branches:
    - main
    - develop
  pull_request:
    branches:
    - main
    - develop
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Login to Harbor
      run: "echo \"${{ secrets.HARBOR_PASSWORD }}\" | docker login harbor.dataknife.net \\\n  -u '${{ secrets.HARBOR_USERNAME\
        \ }}' \\\n  --password-stdin\n"
    - name: Pull base images from Harbor cache
      run: 'docker pull harbor.dataknife.net/dockerhub/library/golang:1.23-alpine || true

        docker pull harbor.dataknife.net/dockerhub/library/alpine:3.18 || true

        '
    - name: Build and push Docker image
      run: "IMAGE_TAG=\"harbor.dataknife.net/library/unifi-protect-mcp\"\n\n# Build with cache from Harbor\ndocker build \\\
        \n  --cache-from harbor.dataknife.net/library/unifi-protect-mcp:latest \\\n  -t ${IMAGE_TAG}:latest \\\n  -f Dockerfile\
        \ .\n\n# Tag with commit SHA if available\nif [ -n \"${{ github.sha }}\" ]; then\n  docker tag ${IMAGE_TAG}:latest\
        \ ${IMAGE_TAG}:${{ github.sha }}\n  docker push ${IMAGE_TAG}:${{ github.sha }}\nfi\n\n# Push latest tag (only on main/develop\
        \ branches)\nif [[ \"${{ github.ref }}\" == \"refs/heads/main\" ]] || [[ \"${{ github.ref }}\" == \"refs/heads/develop\"\
        \ ]]; then\n  docker push ${IMAGE_TAG}:latest\nfi\n"
    - name: Test Docker image
      run: 'docker run --rm harbor.dataknife.net/library/unifi-protect-mcp:latest --help || true

        '
